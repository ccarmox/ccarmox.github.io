<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Pro de Enlaces y Archivos + Editor Visual</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #818cf8;
            --drop-zone: #334155;
            --border: #475569;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg);
            color: white;
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
            transition: background-color 0.3s;
        }

        body.drag-over {
            background-color: #1e1b4b;
        }

        .card {
            background: var(--card);
            padding: 2rem;
            border-radius: 16px;
            width: 100%;
            max-width: 1080px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 2px dashed transparent;
        }

        body.drag-over .card {
            border-color: var(--accent);
        }

        h1, h2, h3 {
            color: var(--accent);
            margin-top: 0;
        }
        
        h1 { text-align: center; margin-bottom: 1.5rem; }
        h3 { font-size: 1.1rem; margin-bottom: 10px; color: #cbd5e1; }

        .group { margin-bottom: 1.2rem; }

        label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: #94a3b8;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            background: #334155;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            box-sizing: border-box;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* --- ESTILOS DEL EDITOR VISUAL --- */
        .editor-container {
            background: #253045;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .visual-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .visual-section.full-width { grid-template-columns: 1fr; }

        .question-card {
            background: #1e293b;
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #334155;
            padding-bottom: 5px;
        }

        .badge {
            background: var(--primary);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .btn-icon {
            background: transparent;
            color: #94a3b8;
            padding: 5px;
            width: auto;
            margin: 0;
            font-size: 1.2rem;
        }
        .btn-icon:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        .btn-add {
            background: var(--success);
            margin-top: 10px;
        }
        .btn-add:hover { background: #059669; }

        .distractor-item {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .json-status {
            font-size: 0.8rem;
            text-align: right;
            margin-top: -10px;
            margin-bottom: 5px;
            min-height: 1.2em;
        }
        .status-ok { color: var(--success); }
        .status-err { color: var(--danger); }

        /* --- FIN ESTILOS EDITOR --- */

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #2d3748;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 1.2rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .checkbox-group:hover { border-color: var(--primary); }
        .checkbox-group input { width: auto; cursor: pointer; margin: 0; }

        button {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            margin-top: 10px;
        }

        button:hover { background: #4338ca; transform: translateY(-1px); }

        .output-box {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #475569;
            display: none;
        }

        .result-item {
            background: #0f172a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }

        .result-item p {
            margin: 0;
            font-size: 0.85rem;
            font-family: monospace;
            word-break: break-all;
            padding-right: 80px;
        }

        .copy-badge {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--success);
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
        }

        .info-drop {
            text-align: center;
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .tab {
            padding: 8px 16px;
            background: #334155;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            user-select: none;
        }
        .tab.active {
            background: var(--accent);
            color: #1e1b4b;
            font-weight: bold;
        }
        
        .hidden { display: none; }
    </style>
</head>

<body>

    <div class="card">
        <h1>üöÄ Generador de Enlaces & Editor</h1>

        <div class="group">
            <label>URL de destino:</label>
            <input type="url" id="baseUrl" placeholder="https://tusitio.com/ver">
        </div>

        <div class="group">
            <label>Contenido del Test:</label>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('visual')">Editor Visual</div>
                <div class="tab" onclick="switchTab('code')">JSON Crudo</div>
            </div>

            <div id="visualEditor" class="editor-container">
                <p style="text-align: center; color: #94a3b8;">Cargando editor...</p>
            </div>

            <div id="jsonEditorContainer" class="hidden">
                <div class="json-status" id="jsonStatus">JSON V√°lido</div>
                <textarea id="texto" rows="15" placeholder='{"title": "..."}' spellcheck="false"></textarea>
                <button onclick="copiarPrompt()" style="margin-bottom: 10px; background: #334155;">Copiar Prompt de ejemplo</button>
            </div>
        </div>

        <label class="checkbox-group">
            <input type="checkbox" id="encryptCheck" checked onchange="toggleKeyInput()">
            <span>Protegido con contrase√±a</span>
        </label>

        <div class="group" id="customKeyContainer">
            <label>Contrase√±a (para generar o para leer archivo arrastrado):</label>
            <input type="text" id="customKey" value="Sheila" placeholder="Escribe tu contrase√±a secreta aqu√≠...">
        </div>

        <button onclick="procesar()">Generar y Descargar Archivo</button>
        <p class="info-drop">üí° Puedes arrastrar un archivo de test .html aqu√≠ para editarlo</p>

        <div id="output" class="output-box">
            <div class="group" id="claveSection">
                <label>Contrase√±a Utilizada:</label>
                <div class="result-item">
                    <p id="resClave"></p>
                    <span class="copy-badge" onclick="copiar('resClave')">Copiar</span>
                </div>
            </div>

            <div class="group">
                <label>Contenido del HTML generado:</label>
                <div class="result-item">
                    <p id="resContenido"></p>
                    <span class="copy-badge" onclick="copiar('resContenido')">Copiar</span>
                </div>
            </div>

            <div class="group">
                <label>URL Final con par√°metros:</label>
                <div class="result-item">
                    <p id="resUrl"></p>
                    <span class="copy-badge" onclick="copiar('resUrl')">Copiar</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN INICIAL ---
        const DEFAULT_JSON = {
            "title": "Nuevo Test",
            "description": "Descripci√≥n del test",
            "lives": 3,
            "help_title": "Ayuda",
            "help_content": "Consejos...",
            "database": [
                { 
                    "val1": "¬øPregunta?", 
                    "val2": "", 
                    "correct": "Respuesta Correcta", 
                    "distractors": ["Incorrecta 1", "Incorrecta 2"], 
                    "error_explanation": "Explicaci√≥n"
                }
            ]
        };

        // Estado para evitar bucles infinitos de actualizaci√≥n
        let isUpdatingFromVisual = false;

        document.addEventListener('DOMContentLoaded', () => {
            const textArea = document.getElementById('texto');
            textArea.value = JSON.stringify(DEFAULT_JSON, null, 2);
            
            // Render inicial
            renderVisualEditor(DEFAULT_JSON);

            // Listener: Cuando cambia el JSON (manual), actualiza visual
            textArea.addEventListener('input', () => {
                if (isUpdatingFromVisual) return; // Evitar loop
                try {
                    const json = JSON.parse(textArea.value);
                    document.getElementById('jsonStatus').innerText = "JSON V√°lido";
                    document.getElementById('jsonStatus').className = "json-status status-ok";
                    renderVisualEditor(json);
                } catch (e) {
                    document.getElementById('jsonStatus').innerText = "Error en JSON: " + e.message;
                    document.getElementById('jsonStatus').className = "json-status status-err";
                }
            });
        });

        function switchTab(mode) {
            const visualDiv = document.getElementById('visualEditor');
            const codeDiv = document.getElementById('jsonEditorContainer');
            const tabs = document.querySelectorAll('.tab');

            if (mode === 'visual') {
                visualDiv.classList.remove('hidden');
                codeDiv.classList.add('hidden');
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
                
                // Asegurar que el visual est√© al d√≠a si se edit√≥ el c√≥digo
                try {
                    renderVisualEditor(JSON.parse(document.getElementById('texto').value));
                } catch(e) {}

            } else {
                visualDiv.classList.add('hidden');
                codeDiv.classList.remove('hidden');
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
            }
        }

        // --- L√ìGICA DEL EDITOR VISUAL ---

        function updateJsonFromVisual() {
            isUpdatingFromVisual = true;
            
            // Recopilar datos Globales
            const newData = {
                title: document.getElementById('v-titulo').value,
                description: document.getElementById('v-desc').value,
                lives: parseInt(document.getElementById('v-vidas').value) || 0,
                help_title: document.getElementById('v-help-title').value,
                help_content: document.getElementById('v-help-content').value,
                database: []
            };

            // Recopilar Preguntas
            const qCards = document.querySelectorAll('.question-card');
            qCards.forEach(card => {
                const q = {
                    val1: card.querySelector('.q-val1').value,
                    val2: card.querySelector('.q-val2').value,
                    correct: card.querySelector('.q-correct').value,
                    error_explanation: card.querySelector('.q-explanation').value,
                    distractors: []
                };
                
                // Recopilar Distractores
                card.querySelectorAll('.d-input').forEach(inp => {
                    if(inp.value.trim() !== "") q.distractors.push(inp.value);
                });

                newData.database.push(q);
            });

            // Actualizar Textarea
            document.getElementById('texto').value = JSON.stringify(newData, null, 2);
            
            // Peque√±o timeout para liberar flag
            setTimeout(() => { isUpdatingFromVisual = false; }, 50);
        }

        function renderVisualEditor(data) {
            const container = document.getElementById('visualEditor');
            container.innerHTML = ''; // Limpiar

            // 1. Campos Globales
            const globalSection = document.createElement('div');
            globalSection.className = 'visual-section';
            globalSection.innerHTML = `
                <div><label>T√≠tulo</label><input type="text" id="v-titulo" value="${escapeHtml(data.title || '')}"></div>
                <div><label>Vidas</label><input type="number" id="v-vidas" value="${data.lives || 3}"></div>
                <div style="grid-column: span 2"><label>Descripci√≥n</label><input type="text" id="v-desc" value="${escapeHtml(data.description || '')}"></div>
            `;
            container.appendChild(globalSection);

            const helpSection = document.createElement('div');
            helpSection.className = 'visual-section';
            helpSection.innerHTML = `
                <div><label>T√≠tulo Ayuda</label><input type="text" id="v-help-title" value="${escapeHtml(data.help_title || '')}"></div>
                <div><label>Contenido Ayuda (Markdown)</label><textarea rows="3" id="v-help-content">${escapeHtml(data.help_content || '')}</textarea></div>
            `;
            container.appendChild(helpSection);

            // 2. Preguntas Header
            container.innerHTML += `<h3>Preguntas (${(data.database || []).length})</h3>`;
            const questionsContainer = document.createElement('div');
            questionsContainer.id = "questions-list";
            container.appendChild(questionsContainer);

            // 3. Renderizar cada pregunta
            if (data.database && Array.isArray(data.database)) {
                data.database.forEach((q, index) => {
                    questionsContainer.appendChild(createQuestionCard(q, index));
                });
            }

            // 4. Bot√≥n a√±adir pregunta
            const addBtn = document.createElement('button');
            addBtn.innerText = "+ A√±adir Pregunta";
            addBtn.className = "btn-add";
            addBtn.onclick = () => {
                const newQ = { val1: "", val2: "", correct: "", distractors: ["", ""], error_explanation: "" };
                // A√±adir al DOM visualmente y actualizar JSON
                document.getElementById('questions-list').appendChild(createQuestionCard(newQ, document.querySelectorAll('.question-card').length));
                updateJsonFromVisual();
            };
            container.appendChild(addBtn);

            // Vincular eventos globales
            ['v-titulo', 'v-vidas', 'v-desc', 'v-help-title', 'v-help-content'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateJsonFromVisual);
            });
        }

        function createQuestionCard(q, index) {
            const card = document.createElement('div');
            card.className = 'question-card';
            
            // Construir HTML interno
            let distractorsHtml = '';
            (q.distractors || []).forEach(d => {
                distractorsHtml += createDistractorInput(d);
            });

            card.innerHTML = `
                <div class="question-header">
                    <span class="badge">Pregunta ${index + 1}</span>
                    <button class="btn-icon" onclick="removeQuestion(this)">üóëÔ∏è</button>
                </div>
                <div class="group">
                    <label>Enunciado (Inicio)</label>
                    <input type="text" class="q-val1 listener" value="${escapeHtml(q.val1 || '')}">
                </div>
                <div class="group">
                    <label>Enunciado (Fin/Contexto)</label>
                    <input type="text" class="q-val2 listener" value="${escapeHtml(q.val2 || '')}">
                </div>
                <div class="visual-section full-width" style="border:none; padding:0; margin:0;">
                    <div>
                        <label style="color:var(--success)">Respuesta Correcta</label>
                        <input type="text" class="q-correct listener" style="border-color: #059669" value="${escapeHtml(q.correct || '')}">
                    </div>
                    <div>
                        <label>Explicaci√≥n Error</label>
                        <input type="text" class="q-explanation listener" value="${escapeHtml(q.error_explanation || '')}">
                    </div>
                </div>
                <div class="group">
                    <label>Respuestas Incorrectas</label>
                    <div class="distractors-container">
                        ${distractorsHtml}
                    </div>
                    <button style="width:auto; padding: 5px 10px; font-size: 0.8rem; margin-top:5px; background: #334155;" onclick="addDistractor(this)">+ Opci√≥n</button>
                </div>
            `;

            // Vincular eventos input
            card.querySelectorAll('.listener').forEach(input => {
                input.addEventListener('input', updateJsonFromVisual);
            });
            // Vincular eventos de distractores ya creados
            card.querySelectorAll('.d-input').forEach(input => {
                input.addEventListener('input', updateJsonFromVisual);
            });

            return card;
        }

        function createDistractorInput(val) {
            return `
                <div class="distractor-item">
                    <input type="text" class="d-input" value="${escapeHtml(val)}" placeholder="Opci√≥n incorrecta">
                    <button class="btn-icon" style="width: 40px" onclick="removeDistractor(this)">‚úï</button>
                </div>
            `;
        }

        // Helpers del DOM para el editor
        window.removeQuestion = function(btn) {
            if(confirm('¬øBorrar esta pregunta?')) {
                btn.closest('.question-card').remove();
                updateJsonFromVisual();
            }
        };

        window.addDistractor = function(btn) {
            const container = btn.previousElementSibling;
            const div = document.createElement('div');
            div.innerHTML = createDistractorInput("");
            const newItem = div.firstElementChild;
            container.appendChild(newItem);
            
            newItem.querySelector('input').addEventListener('input', updateJsonFromVisual);
            updateJsonFromVisual(); // Actualizar estructura vac√≠a
        };

        window.removeDistractor = function(btn) {
            btn.closest('.distractor-item').remove();
            updateJsonFromVisual();
        };

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- GESTI√ìN DE ARRASTRE DE ARCHIVOS (Mantenida y adaptada) ---

        const body = document.body;

        ['dragover', 'dragleave', 'drop'].forEach(evt => {
            body.addEventListener(evt, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        body.addEventListener('dragover', () => body.classList.add('drag-over'));
        body.addEventListener('dragleave', () => body.classList.remove('drag-over'));

        body.addEventListener('drop', async (e) => {
            body.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];

            if (file && (file.type === "text/html" || file.name.endsWith('.html'))) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    await leerArchivoInyectado(event.target.result);
                };
                reader.readAsText(file);
            } else {
                alert("Por favor, arrastra un archivo HTML v√°lido.");
            }
        });

        async function leerArchivoInyectado(htmlString) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlString, 'text/html');
                const scriptDb = doc.getElementById('database');

                if (!scriptDb) {
                    alert("No se encontr√≥ el bloque <script id='database'> en este archivo.");
                    return;
                }

                const contenidoExtraido = scriptDb.textContent.trim();
                const password = document.getElementById('customKey').value.trim();
                const crypto = await encriptacion();

                let jsonStr = contenidoExtraido;

                if (password) {
                    try {
                        const bytes = crypto.AES.decrypt(contenidoExtraido, password);
                        const decrypted = bytes.toString(crypto.enc.Utf8);
                        if (!decrypted) throw new Error("Clave incorrecta");
                        jsonStr = decrypted;
                        alert("‚úÖ Archivo desencriptado.");
                    } catch (err) {
                        alert("‚ö†Ô∏è No se pudo desencriptar con esa clave. Se cargar√° el contenido crudo.");
                    }
                }

                document.getElementById('texto').value = jsonStr;
                
                // Intentar renderizar visualmente tras cargar
                try {
                    const jsonObj = JSON.parse(jsonStr);
                    renderVisualEditor(jsonObj);
                } catch(e) {
                    console.log("El contenido cargado no es JSON v√°lido para el editor visual");
                }

            } catch (error) {
                console.error(error);
                alert("Error al procesar el archivo.");
            }
        }

        // --- L√ìGICA DE ENCRIPTACI√ìN Y GENERACI√ìN ---

        async function encriptacion() {
            try {
                const modulo = await import('https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/+esm');
                return modulo.default;
            } catch (error) {
                console.error("Error cargando CryptoJS:", error);
            }
        }

        async function obtenerContenido(rutaLocal, rutaBackup) {
            try {
                let respuesta = await fetch(rutaLocal);
                if (!respuesta.ok) throw new Error();
                return await respuesta.text();
            } catch (error) {
                try {
                    const respuestaBackup = await fetch(rutaBackup);
                    return await respuestaBackup.text();
                } catch (e) {
                    return "";
                }
            }
        }

        function toggleKeyInput() {
            const checked = document.getElementById('encryptCheck').checked;
            document.getElementById('customKey').disabled = !checked;
        }

        function generarPassword(longitud = 16) {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let pass = '';
            for (let i = 0; i < longitud; i++) {
                pass += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return pass;
        }

        function descargarArchivo(nombre, contenido) {
            const blob = new Blob([contenido], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombre;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function copiarPrompt() {
            const texto = await obtenerContenido("../../../ui/html_web_generador_test_prompt.txt", "https://ccarmox.github.io/sandbox3/ui/html_web_generador_test_prompt.txt");
            navigator.clipboard.writeText(texto);
            alert("Prompt copiado al portapapeles ‚ú®");
        }

        async function procesar() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const textoOriginal = document.getElementById('texto').value;
            const debeEncriptar = document.getElementById('encryptCheck').checked;
            const userKey = document.getElementById('customKey').value.trim();

            if (!textoOriginal) {
                alert("El contenido JSON est√° vac√≠o.");
                return;
            }

            // Validar JSON antes de procesar
            try {
                JSON.parse(textoOriginal);
            } catch(e) {
                if(!confirm("El JSON parece inv√°lido. ¬øGenerar de todas formas?")) return;
            }

            let nombreArchivo = "index.html";
            try {
                if(baseUrl) {
                    const urlObj = new URL(baseUrl);
                    const lastSegment = urlObj.pathname.substring(urlObj.pathname.lastIndexOf('/') + 1);
                    nombreArchivo = lastSegment.includes('.') ? lastSegment : (lastSegment ? lastSegment + ".html" : "index.html");
                }
            } catch (e) {}

            let contenidoFinal = textoOriginal;
            let claveFinal = "";
            let urlParams = "";

            if (debeEncriptar) {
                const crypto = await encriptacion();
                claveFinal = userKey || generarPassword();
                contenidoFinal = crypto.AES.encrypt(textoOriginal, claveFinal).toString();
                urlParams = `?key=${encodeURIComponent(claveFinal)}`;
                document.getElementById('claveSection').style.display = 'block';
            } else {
                document.getElementById('claveSection').style.display = 'none';
            }

            try {
                const plantilla = await obtenerContenido("../../../ui/html_web_generador_test.html", "https://ccarmox.github.io/sandbox3/ui/html_web_generador_test.html");
                
                const htmlGenerado = plantilla.replace('#JSON_DATABASE', contenidoFinal);
                const urlFinal = baseUrl ? `${baseUrl}${urlParams}` : "(Solo archivo local)";

                document.getElementById('resClave').innerText = claveFinal || "(no encriptado)";
                document.getElementById('resContenido').innerText = "Archivo generado (" + htmlGenerado.length + " bytes)";
                document.getElementById('resUrl').innerText = urlFinal;
                document.getElementById('output').style.display = 'block';

                descargarArchivo(nombreArchivo, htmlGenerado);
            } catch (error) {
                alert("Error: " + error.message);
            }
        }

        function copiar(id) {
            const texto = document.getElementById(id).innerText;
            navigator.clipboard.writeText(texto);
            alert("Copiado al portapapeles ‚ú®");
        }
    </script>

</body>
</html>