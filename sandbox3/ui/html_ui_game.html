<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="main-title">Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --error: #c0392b;
            --victory: #f1c40f;
        }

        /* Azul Brillante (Se mantiene, es un cl√°sico) */
        .color-0 {
            border: 3px solid #71a4f7;
            background-color: #4285F4;
            color: #FFFFFF;
        }

        /* P√∫rpura El√©ctrico (Sustituye al Rojo) */
        .color-1 {
            border: 3px solid #c87ff0;
            background-color: #A142F4;
            color: #FFFFFF;
        }

        /* Amarillo Intenso (Se mantiene, es muy legible) */
        .color-2 {
            border: 3px solid #ffd965;
            background-color: #FBBC05;
            color: #343434;
        }

        /* Naranja Ne√≥n (Sustituye al Verde) */
        .color-3 {
            border: 3px solid #ff9d5c;
            background-color: #FF6D00;
            color: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            color: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0px;
        }

        body {
            min-height: 100vh;
            margin: 0;
            /* Fondo base con gradiente suave */
            background-color: #f0f4f8;
            background-image:
                /* Trama de puntos (Grid de juego) */
                radial-gradient(#d1d9e6 2px, transparent 2px),
                /* Gradiente animado de fondo */
                linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            background-size: 40px 40px, 100% 100%;
            background-attachment: fixed;

            /* Fuente amigable para lectura */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #2d3748;

            /* Efecto de brillo sutil en la esquina */
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: -25%;
            right: -10%;
            width: 50%;
            height: 80%;
            background: radial-gradient(circle, rgba(66, 153, 225, 0.15) 0%, transparent 70%);
            z-index: -1;
            border-radius: 50%;
        }

        body::after {
            content: "";
            position: fixed;
            bottom: -10%;
            left: -5%;
            width: 40%;
            height: 60%;
            background: radial-gradient(circle, rgba(72, 187, 120, 0.1) 0%, transparent 70%);
            z-index: -1;
            border-radius: 50%;
        }

        .game-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            overflow: hidden;
            position: relative;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: #34495e;
            color: #bdc3c7;
            font-size: 0.9em;
        }

        .question-area {
            padding: 30px 20px;
            text-align: center;
        }

        .chemical-formula {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 20px;
            height: 60px;
        }

        .instruction {
            color: #7f8c8d;
            margin-bottom: 25px;
            font-style: italic;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 0 20px 70px;
        }

        @media (min-width: 500px) {
            .options-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        button.option-btn {
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
        }

        button.option-btn:hover {
            filter: brightness(1.1);
        }

        button.option-btn:active {
            filter: brightness(1.3);
        }

        button.option-btn.correct {
            background-color: var(--success) !important;
            color: white;
            border-color: var(--success);
        }

        button.option-btn.wrong {
            background-color: var(--error) !important;
            color: white;
            border-color: var(--error);
        }

        .feedback-modal {
            box-sizing: border-box;
            padding: 30px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            display: none;
            text-align: center;
            z-index: 10;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 30px;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
        }

        .next-btn {
            background: var(--primary);
        }

        .share-btn {
            background: var(--accent);
            display: none;
        }

        sub {
            font-size: 0.6em;
        }

        .context-area {
            background-color: #f8f9fa;
            padding: 35px 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .context-area h3 {
            margin: 0;
            color: var(--accent);
            text-transform: uppercase;
            font-size: 1.1em;
        }

        .play-area {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .progress-container {
            width: 100%;
            background: #eee;
            height: 10px;
        }

        #progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }


        /* =========================================
           ESTILOS DEL CONFETTI MEJORADO (ca√≠da)
           ========================================= */
        .confetti-piece {
            position: fixed;
            top: -20px;
            /* Empiezan fuera de la pantalla arriba */
            opacity: 0.8;
            z-index: 20;
        }

        /* Animaci√≥n de ca√≠da con balanceo 3D */
        @keyframes caer-balanceado {
            0% {
                transform: translateY(0) rotateX(0) rotateZ(0);
                opacity: 1;
            }

            25% {
                transform: translateY(25vh) translateX(20px) rotateX(180deg) rotateZ(45deg);
            }

            50% {
                transform: translateY(50vh) translateX(-20px) rotateX(360deg) rotateZ(90deg);
            }

            75% {
                transform: translateY(75vh) translateX(20px) rotateX(540deg) rotateZ(135deg);
            }

            100% {
                transform: translateY(110vh) translateX(0) rotateX(720deg) rotateZ(180deg);
                opacity: 0;
            }
        }

        /* =========================================
           ESTILOS DE FUEGOS ARTIFICIALES (explosi√≥n)
           ========================================= */
        .firework-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            box-shadow: 0 0 6px currentColor;
            /* Resplandor */
            /* Usamos variables CSS para definir el destino de la explosi√≥n */
            transform: translate(0, 0);
            animation: explosion 1s ease-out forwards;
            z-index: 20;
        }

        @keyframes explosion {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            100% {
                /* Se mueven hacia las variables definidas en JS y se encogen */
                transform: translate(var(--dest-x), var(--dest-y)) scale(0.1);
                opacity: 0;
            }
        }
    </style>
</head>

<body id="particle-container">
    <div class="game-container">
        <header>
            <h1 id="main-description">üß™ Qu√≠mica</h1>
        </header>

        <div class="stats-bar">
            <span id="score">Puntos: 0</span>
            <span id="progress-text">0/0</span>
            <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
        </div>


        <div class="context-area">
            <h3 id="help-title">Tema: Formulaci√≥n</h3>
            <p id="help-desc">Selecciona la opci√≥n correcta.</p>
        </div>

        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>

        <div class="play-area">
            <div class="question-area">
                <div class="instruction" id="instruction">Cargando...</div>
                <div class="chemical-formula" id="display">---</div>
            </div>

            <div class="options-grid" id="options-container"></div>

            <div class="feedback-modal" id="modal">
                <h2 id="modal-title">¬°Correcto!</h2>
                <p id="modal-msg">Muy bien hecho.</p>
                <div class="modal-buttons">
                    <button id="action-btn" class="modal-btn next-btn" onclick="nextQuestion()">Siguiente</button>
                    <button id="share-btn" class="modal-btn share-btn" onclick="shareScore()">üì§ Compartir</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS ---
        // Se asume que json_data viene de un script externo. Si no, usamos este ejemplo:
        const database_fallback = [
            { val1: "¬øCu√°l es el nombre de este compuesto?", val2: "NaCl", correct: "Cloruro de sodio", distractors: ["Sodio de cloro", "Clorato s√≥dico", "Cloro de sodio"], error_explanation: "Es una sal binaria simple." },
            { val1: "¬øCu√°l es el nombre de este compuesto?", val2: "H2O", correct: "Agua", distractors: ["Oxidano", "Di√≥xido de hidr√≥geno", "√Åcido h√≠drico"], error_explanation: "" },
            { val1: "¬øCu√°l es el nombre de este compuesto?", val2: "CO2", correct: "Di√≥xido de carbono", distractors: ["Mon√≥xido de carbono", "√ìxido de carbono", "Carbonato"], error_explanation: "" }
        ];

        let score = 0;
        let streak = 0;
        let lives = 0;
        let currentQuestion = null;
        let questionsPool = []; // Preguntas que quedan por acertar
        let totalQuestions = 0;

        function formatear(str) {
            if (!str) return "";
            return str
                .replace(/^###\s*(.*$)/gm, '<h3>$1</h3>')
                .replace(/^\*\s*(.*$)/gm, '<li>$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/_(\d+)/g, '<sub>$1</sub>')
                .replace(/\^(\d+)/g, '<sup>$1</sup>');
        }


        function obtenerMensajeCorrecto() {
            const mensajes = [
                // --- √âpicas y Directas ---
                "¬°Exacto! Est√°s en racha. üî•",
                "¬°Brillante! Ni Einstein lo habr√≠a hecho mejor. üß†",
                "¬°Eso es! Tu cerebro est√° a otro nivel hoy. üöÄ",
                "¬°Pum! Respuesta perfecta. üéØ",
                "¬°Incre√≠ble! Lo haces ver muy f√°cil. ‚ú®",
                "¬°Diste en el clavo! Sigue as√≠. üôå",
                "¬°Imparable! Tienes el control total. üí™",

                // --- Con Humor / Ingeniosas ---
                "¬°Correcto! Tiembla, Google, aqu√≠ llega la competencia. üòâ",
                "¬øSeguro que no est√°s haciendo trampa? ¬°Eres demasiado bueno! üëÄ",
                "Tu teclado debe estar echando humo con tanto acierto. üí®",
                "¬°Boom! Esa respuesta ha sido legendaria. üé∏",
                "¬°Confirmado! Eres la persona m√°s inteligente en esta habitaci√≥n. (Probablemente). üèÜ",
                "¬°Hackeaste el sistema! Ah, no, espera... es que eres muy inteligente. üíª",

                // --- Motivadoras y C√°lidas ---
                "¬°Sab√≠a que lo lograr√≠as! Confianza al 100%. üåü",
                "Cada acierto te acerca m√°s a la maestr√≠a. üéì",
                "¬°Qu√© elegancia la de Francia! Respuesta perfecta. üé©",
                "¬°Wow! Me has dejado sin palabras. üëè",
                "¬°Sigue as√≠! Est√°s dominando el tema por completo. üîù",
                "¬°Toma ya! Una m√°s para la colecci√≥n de victorias. üèÖ",
                "¬°Nivel Dios activado! ‚ö°"
            ];

            const indiceAleatorio = Math.floor(Math.random() * mensajes.length);
            return mensajes[indiceAleatorio];
        }

        function obtenerMensajeIncorrecto() {
            const mensajesAnimo = [
                // --- Empat√≠a y Apoyo ---
                "Casi lo tienes, ¬°no te rindas ahora! üí™",
                "¬°No pasa nada! De los errores se aprende m√°s que de los aciertos. ‚ú®",
                "Estuviste muy cerca. ¬°Dale otra oportunidad! üîÑ",
                "Incluso los genios fallan a veces. ¬°Sigue adelante! üß†",
                "Tu cerebro est√° calentando motores, ¬°la pr√≥xima es la tuya! üî•",

                // --- Con un toque de Humor ---
                "¬°Ups! El teclado te ha traicionado, estoy seguro. üëÄ",
                "Eso fue un 'ensayo cl√≠nico'. Ahora viene la de verdad. üòâ",
                "404: Respuesta no encontrada... pero tu talento sigue ah√≠. üíª",
                "El sistema dice que no, pero yo conf√≠o en ti. ü§ñ",
                "Esa respuesta era demasiado avanzada para esta pregunta. ¬°Prueba otra! üöÄ",

                // --- Motivaci√≥n Directa ---
                "¬°A la carga de nuevo! T√∫ puedes con esto. üõ°Ô∏è",
                "Ni un paso atr√°s, ¬°vuelve a intentarlo! üëä",
                "¬°Casi rozas la gloria! Int√©ntalo una vez m√°s. üåü",
                "El √©xito es la suma de peque√±os intentos. ¬°Vas por buen camino! üìà"
            ];

            const indiceAleatorio = Math.floor(Math.random() * mensajesAnimo.length);
            return mensajesAnimo[indiceAleatorio];
        }

        function obtenerMensajeFinVidas() {
            const mensajesFin = [
                // --- Enfoque en el Progreso ---
                "¬°Se acabaron las vidas, pero no el talento! T√≥mate un respiro y vuelve a por el r√©cord. üéÆ",
                "Has llegado muy lejos en esta ronda. ¬°La pr√≥xima vez llegar√°s incluso m√°s all√°! üèÜ",
                "Tu puntuaci√≥n dice 'Fin', pero tu cerebro dice '¬°He aprendido algo nuevo!'. üß†",
                "¬°Game Over! Pero recuerda: cada partida te hace m√°s sabio que la anterior. üìñ",

                // --- Estilo Gaming / √âpico ---
                "Incluso los mejores necesitan un 'respawn'. ¬°Recarga energ√≠as y vuelve a la carga! ‚ö°",
                "Has ca√≠do con honor. ¬°Lev√°ntate, sac√∫dete el polvo y demuestra de qu√© est√°s hecho! üî•",
                "¬øUn descanso? Tu teclado te lo agradecer√°, pero yo te espero aqu√≠ para la revancha. ü•ä",
                "¬°Casi bates tu propia marca! Un intento m√°s y el podio es tuyo. üéØ",

                // --- Motivaci√≥n y Resiliencia ---
                "Las vidas son limitadas, pero tu potencial no. ¬°Vuelve a intentarlo cuando est√©s listo! ‚ú®",
                "No lo veas como un final, sino como un punto de control para volver con m√°s fuerza. üíæ",
                "¬°Buen intento! Roma no se construy√≥ en un d√≠a, y tu maestr√≠a tampoco. üèõÔ∏è",
                "¬°Insert Coin emocional! Tienes todo lo necesario para superar este nivel. üïπÔ∏è"
            ];

            const indiceAleatorio = Math.floor(Math.random() * mensajesFin.length);
            return mensajesFin[indiceAleatorio];
        }

        function startGame() {
            score = 0;
            streak = 0;
            const data = (window.json_data && window.json_data.database) ? window.json_data.database : database_fallback;

            // Clonamos la base de datos para el pool de preguntas
            questionsPool = [...data];
            totalQuestions = questionsPool.length;
            lives = (window.json_data && window.json_data.lives) ? window.json_data.lives : 3;

            if (window.json_data) {
                document.getElementById('help-title').innerHTML = formatear(window.json_data.help_title) || "Tema";
                document.getElementById('help-desc').innerHTML = formatear(window.json_data.help_content) || "Instrucci√≥n";
                document.getElementById('main-description').innerHTML = formatear(window.json_data.title) || "T√≠tulo";
            }

            updateStats();
            loadRandomQuestion();
        }

        function updateStats() {
            document.getElementById('score').innerText = `Puntos: ${score}`;
            let hearts = "";
            for (let i = 0; i < lives; i++) hearts += "‚ù§Ô∏è";
            document.getElementById('lives').innerText = hearts;

            // Progreso
            const acertadas = totalQuestions - questionsPool.length;
            document.getElementById('progress-text').innerText = `${acertadas}/${totalQuestions}`;
            const percent = (acertadas / totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = percent + "%";
        }

        function createSmoke(target) {
            const particleCount = 15;
            const rect = target.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < particleCount; i++) {
                const smoke = document.createElement('div');

                // Estilo de la part√≠cula de humo
                const size = Math.random() * 20 + 10;
                smoke.style.position = 'fixed';
                smoke.style.width = `${size}px`;
                smoke.style.height = `${size}px`;
                smoke.style.background = 'rgba(150, 150, 150, 0.8)'; // Gris con transparencia
                smoke.style.borderRadius = '50%'; // Forma circular para parecer humo
                smoke.style.filter = 'blur(5px)'; // Desenfoque para suavizar el humo
                smoke.style.zIndex = '9999';
                smoke.style.pointerEvents = 'none';

                smoke.style.left = `${centerX}px`;
                smoke.style.top = `${centerY}px`;

                document.body.appendChild(smoke);

                // Destino: hacia arriba con una ligera desviaci√≥n lateral
                const destinationX = (Math.random() - 0.5) * 60; // Desviaci√≥n de -30 a 30
                const destinationY = - (Math.random() * 80 + 40); // Siempre hacia arriba
                const finalSize = size * 2; // El humo se expande mientras sube

                smoke.animate([
                    {
                        transform: 'translate(-50%, -50%) scale(1)',
                        opacity: 0.8
                    },
                    {
                        transform: `translate(calc(-50% + ${destinationX}px), calc(-50% + ${destinationY}px)) scale(2)`,
                        opacity: 0
                    }
                ], {
                    duration: Math.random() * 800 + 700,
                    easing: 'ease-out',
                    fill: 'forwards'
                }).onfinish = () => smoke.remove();
            }
        }

        function lanzarConfetti(target) {
            const particleCount = 30; // N√∫mero de rect√°ngulos
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];

            // Obtenemos la posici√≥n del bot√≥n para que el confetti salga de ah√≠
            const rect = target.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');

                // Estilo b√°sico: forma rectangular
                const width = Math.random() * 8 + 4;
                const height = Math.random() * 4 + 2;

                particle.style.position = 'fixed';
                particle.style.width = `${width}px`;
                particle.style.height = `${height}px`;
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.zIndex = '9999';
                particle.style.pointerEvents = 'none'; // Para que no estorben al hacer clic

                // Posici√≥n inicial (centro del bot√≥n)
                particle.style.left = `${centerX}px`;
                particle.style.top = `${centerY}px`;

                // Generar una direcci√≥n aleatoria (360 grados) y distancia
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 100 + 50; // Distancia que recorrer√°n
                const destinationX = Math.cos(angle) * velocity;
                const destinationY = Math.sin(angle) * velocity;
                const rotation = Math.random() * 720; // Rotaci√≥n final

                document.body.appendChild(particle);

                // Animaci√≥n con Web Animations API (JS puro moderno)
                particle.animate([
                    {
                        transform: 'translate(-50%, -50%) translate(0, 0) rotate(0deg)',
                        opacity: 1
                    },
                    {
                        transform: `translate(-50%, -50%) translate(${destinationX}px, ${destinationY}px) rotate(${rotation}deg)`,
                        opacity: 0
                    }
                ], {
                    duration: Math.random() * 1000 + 500, // Entre 0.5s y 1.5s
                    easing: 'cubic-bezier(0, .9, .57, 1)',
                    fill: 'forwards'
                }).onfinish = () => particle.remove(); // Eliminar del DOM al terminar
            }
        }

        function loadRandomQuestion() {
            if (lives <= 0) return; // Ya gestionado por el modal

            if (questionsPool.length === 0) {
                return showVictory();
            }

            const randomIndex = Math.floor(Math.random() * questionsPool.length);
            currentQuestion = questionsPool[randomIndex];

            let options = [...currentQuestion.distractors, currentQuestion.correct];
            options.sort(() => Math.random() - 0.5);

            const display = document.getElementById('display');
            const instruction = document.getElementById('instruction');
            const container = document.getElementById('options-container');

            container.innerHTML = '';
            instruction.innerText = currentQuestion.val1;
            display.innerHTML = formatear(currentQuestion.val2);

            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = `option-btn color-${index % 4}`;
                btn.innerHTML = formatear(opt);
                btn.onclick = () => checkAnswer(opt, btn);
                container.appendChild(btn);
            });

            document.getElementById('modal').style.display = 'none';
        }

        function checkAnswer(selected, btnElement) {
            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.disabled = true);

            const isCorrect = (selected === currentQuestion.correct);

            if (isCorrect) {
                lanzarConfetti(btnElement);
                btnElement.classList.add('correct');
                score += 10 + (streak * 2);
                streak++;

                // IMPORTANTE: Si acierta, eliminamos la pregunta del pool
                questionsPool = questionsPool.filter(q => q !== currentQuestion);

                setTimeout(() => showModal(true), 600);
            } else {
                btnElement.classList.add('wrong');
                lives--;
                streak = 0;
                // Si falla, la pregunta SE QUEDA en el pool para repetirse luego
                allBtns.forEach(b => {
                    if (b.innerHTML === formatear(currentQuestion.correct)) {
                        b.classList.add('correct');
                        lanzarConfetti(b);
                    }
                });
                setTimeout(() => showModal(false), 900);
            }
            updateStats();
        }

        function showModal(isWin) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const msg = document.getElementById('modal-msg');
            const actionBtn = document.getElementById('action-btn');
            const shareBtn = document.getElementById('share-btn');

            modal.style.display = 'flex';
            shareBtn.style.display = 'none';

            if (!isWin && lives <= 0) {
                title.innerText = obtenerMensajeFinVidas();
                title.style.color = "var(--error)";
                msg.innerHTML = `Te has quedado sin vidas.<br>Puntuaci√≥n: ${score}`;
                actionBtn.innerText = "Reintentar todo";
                actionBtn.onclick = startGame;
                return;
            }

            if (isWin) {
                title.innerText = "¬°Correcto!";
                title.style.color = "var(--success)";
                msg.innerText = obtenerMensajeCorrecto();
                actionBtn.innerText = "Siguiente";
                actionBtn.onclick = nextQuestion;
            } else {
                title.innerText = obtenerMensajeIncorrecto();
                title.style.color = "var(--error)";
                let expl = currentQuestion.error_explanation ? `<br><small>${currentQuestion.error_explanation}</small>` : "";
                msg.innerHTML = `La respuesta correcta era:<br><br><strong>${currentQuestion.correct}</strong><br>${expl}`;
                actionBtn.innerText = "Continuar";
                actionBtn.onclick = nextQuestion;
            }
        }

        function showVictory() {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const msg = document.getElementById('modal-msg');
            const actionBtn = document.getElementById('action-btn');
            const shareBtn = document.getElementById('share-btn');

            score = score + 500 * lives;

            modal.style.display = 'flex';
            title.innerText = "¬°ENHORABUENA! üèÜ";
            title.style.color = "var(--victory)";
            msg.innerHTML = `¬°Has completado todas las preguntas!<br>Puntuaci√≥n final: <strong>${score}</strong><br>Vidas restantes: ${lives}`;

            actionBtn.innerText = "Jugar de nuevo";
            actionBtn.onclick = startGame;
            shareBtn.style.display = 'block';

            celebracion();
        }

        function nextQuestion() {
            loadRandomQuestion();
        }

        function shareScore() {
            const text = `¬°He completado el test de Qu√≠mica con ${score} puntos! üß™‚ú®`;
            if (navigator.share) {
                navigator.share({ title: 'Reto Qu√≠mica', text: text });
            } else {
                navigator.clipboard.writeText(text);
                alert("Puntuaci√≥n copiada al portapapeles");
            }
        }

        /* C E L E B R A C I O N */
        // Utilidad para obtener colores aleatorios vibrantes
        function getRandomColor() {
            const colors = [
                '#FF3366', // Rosa vibrante
                '#2EC4B6', // Turquesa oscuro
                '#FF9F1C', // Naranja mandarina
                '#7209B7', // P√∫rpura real
                '#3A86FF', // Azul brillante
                '#EF476F', // Rojo coral
                '#06D6A0', // Verde esmeralda
                '#FFD166'  // Oro suave (visible en blanco)
            ]; return colors[Math.floor(Math.random() * colors.length)];
        }

        // Utilidad para obtener n√∫meros aleatorios en un rango
        function randomRange(min, max) {
            return Math.random() * (max - min) + min;
        }

        // --- FUNCI√ìN 1: Confetti que cae ---
        function lanzarConfettiGeneral() {
            const numConfetti = 170; // Cantidad de papelitos
            const container = document.getElementById('particle-container');

            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti-piece');

                // Forma rectangular aleatoria para m√°s realismo
                confetti.style.width = `${randomRange(8, 15)}px`;
                confetti.style.height = `${randomRange(5, 10)}px`;
                confetti.style.backgroundColor = getRandomColor();

                // Posici√≥n horizontal inicial aleatoria (0 a 100% del ancho)
                confetti.style.left = `${randomRange(0, 100)}%`;

                // Duraci√≥n y retraso aleatorios para que no caigan en bloque
                const duration = randomRange(5, 7.5) + 's';
                const delay = randomRange(0, 3.5) + 's';

                // Aplicar la animaci√≥n CSS compleja
                confetti.style.animation = `caer-balanceado ${duration} linear ${delay} forwards`;

                container.appendChild(confetti);

                // Limpieza: eliminar el elemento del DOM cuando termine
                setTimeout(() => confetti.remove(), 8000);
            }
        }

        // --- FUNCI√ìN 2: Fuegos Artificiales (Explosiones) ---
        function lanzarFuegoArtificial() {
            // Calculamos el scroll actual
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;

            // El X se mantiene igual (ancho de pantalla)
            const centerX = window.innerWidth * randomRange(0.2, 0.8);

            // IMPORTANTE: Sumamos el scrollY para que aparezca en el trozo visible
            const centerY = (window.innerHeight * randomRange(0.1, 0.5)) + scrollY;

            const colorExplosion = getRandomColor();
            const numParticulas = 40;
            const container = document.getElementById('particle-container');

            for (let i = 0; i < numParticulas; i++) {
                const particle = document.createElement('div');
                particle.classList.add('firework-particle');
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px'; // Ahora usa la posici√≥n con scroll

                particle.style.backgroundColor = colorExplosion;
                particle.style.color = colorExplosion;

                const angle = randomRange(0, 360);
                const distance = randomRange(50, 250);
                const destX = Math.cos(angle * Math.PI / 180) * distance + 'px';
                const destY = Math.sin(angle * Math.PI / 180) * distance + 'px';

                particle.style.setProperty('--dest-x', destX);
                particle.style.setProperty('--dest-y', destY);

                container.appendChild(particle);
                setTimeout(() => particle.remove(), 1100);
            }
        }

        // --- FUNCI√ìN PRINCIPAL: Llama a todo ---
        function celebracion() {
            // 1. Lanzar el confetti que cae
            lanzarConfettiGeneral();

            // 2. Lanzar varias explosiones de fuegos artificiales con peque√±os retrasos
            lanzarFuegoArtificial();
            lanzarFuegoArtificial();
            lanzarFuegoArtificial();

            setTimeout(lanzarFuegoArtificial, 400);
            setTimeout(lanzarFuegoArtificial, 400);
            setTimeout(lanzarFuegoArtificial, 400);
            setTimeout(lanzarFuegoArtificial, 400);

            setTimeout(lanzarFuegoArtificial, 500);
            setTimeout(lanzarFuegoArtificial, 500);
            setTimeout(lanzarFuegoArtificial, 500);
            setTimeout(lanzarFuegoArtificial, 500);

            setTimeout(lanzarFuegoArtificial, 600);
            setTimeout(lanzarFuegoArtificial, 600);

            setTimeout(lanzarFuegoArtificial, 700);
            setTimeout(lanzarFuegoArtificial, 700);
            setTimeout(lanzarFuegoArtificial, 700);

            setTimeout(lanzarFuegoArtificial, 800);
            setTimeout(lanzarFuegoArtificial, 800);

            setTimeout(lanzarFuegoArtificial, 900);
            setTimeout(lanzarFuegoArtificial, 900);

            setTimeout(lanzarFuegoArtificial, 1000);
            setTimeout(lanzarFuegoArtificial, 1000);

            setTimeout(lanzarFuegoArtificial, 1100);
            setTimeout(lanzarFuegoArtificial, 1200);
            setTimeout(lanzarFuegoArtificial, 1300);


        }

        window.addEventListener("message", (event) => {
            // Verificamos que sea el mensaje correcto
            if (event.data && event.data.type === "INIT_DATA") {
                window.json_data = event.data.payload;

                startGame();
            }
        });
    </script>
</body>

</html>