<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="main-title">Formulaci贸n qu铆mica</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --error: #c0392b;
            --victory: #f1c40f;
        }

        /* Azul Brillante (Se mantiene, es un cl谩sico) */
        .color-0 {
            border: 3px solid #71a4f7;
            background-color: #4285F4;
            color: #FFFFFF;
        }

        /* P煤rpura El茅ctrico (Sustituye al Rojo) */
        .color-1 {
            border: 3px solid #c87ff0;
            background-color: #A142F4;
            color: #FFFFFF;
        }

        /* Amarillo Intenso (Se mantiene, es muy legible) */
        .color-2 {
            border: 3px solid #ffd965;
            background-color: #FBBC05;
            color: #343434;
        }

        /* Naranja Ne贸n (Sustituye al Verde) */
        .color-3 {
            border: 3px solid #ff9d5c;
            background-color: #FF6D00;
            color: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            color: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0px;
        }

        .game-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            overflow: hidden;
            position: relative;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: #34495e;
            color: #bdc3c7;
            font-size: 0.9em;
        }

        .question-area {
            padding: 30px 20px;
            text-align: center;
        }

        .chemical-formula {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 20px;
            height: 60px;
        }

        .instruction {
            color: #7f8c8d;
            margin-bottom: 25px;
            font-style: italic;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 0 20px 70px;
        }

        @media (min-width: 500px) {
            .options-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        button.option-btn {
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
        }

        button.option-btn:hover {
            filter: brightness(1.1);
        }

        button.option-btn:active {
            filter: brightness(1.3);
        }

        button.option-btn.correct {
            background-color: var(--success) !important;
            color: white;
            border-color: var(--success);
        }

        button.option-btn.wrong {
            background-color: var(--error) !important;
            color: white;
            border-color: var(--error);
        }

        .feedback-modal {
            box-sizing: border-box;
            padding: 30px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            display: none;
            text-align: center;
            z-index: 10;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 30px;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
        }

        .next-btn {
            background: var(--primary);
        }

        .share-btn {
            background: var(--accent);
            display: none;
        }

        sub {
            font-size: 0.6em;
        }

        .context-area {
            background-color: #f8f9fa;
            padding: 35px 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .context-area h3 {
            margin: 0;
            color: var(--accent);
            text-transform: uppercase;
            font-size: 1.1em;
        }

        .play-area {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .progress-container {
            width: 100%;
            background: #eee;
            height: 5px;
        }

        #progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>

<body>

    <div class="game-container">
        <header>
            <h1 id="main-description">И Qu铆mica</h1>
        </header>

        <div class="stats-bar">
            <span id="score">Puntos: 0</span>
            <span id="progress-text">0/0</span>
            <span id="lives">わわわ</span>
        </div>

        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>

        <div class="context-area">
            <h3 id="help-title">Tema: Formulaci贸n</h3>
            <p id="help-desc">Selecciona la opci贸n correcta.</p>
        </div>

        <div class="play-area">
            <div class="question-area">
                <div class="instruction" id="instruction">Cargando...</div>
                <div class="chemical-formula" id="display">---</div>
            </div>

            <div class="options-grid" id="options-container"></div>

            <div class="feedback-modal" id="modal">
                <h2 id="modal-title">隆Correcto!</h2>
                <p id="modal-msg">Muy bien hecho.</p>
                <div class="modal-buttons">
                    <button id="action-btn" class="modal-btn next-btn" onclick="nextQuestion()">Siguiente</button>
                    <button id="share-btn" class="modal-btn share-btn" onclick="shareScore()"> Compartir</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS ---
        // Se asume que json_data viene de un script externo. Si no, usamos este ejemplo:
        const database_fallback = [
            { val1: "驴Cu谩l es el nombre de este compuesto?", val2: "NaCl", correct: "Cloruro de sodio", distractors: ["Sodio de cloro", "Clorato s贸dico", "Cloro de sodio"], error_explanation: "Es una sal binaria simple." },
            { val1: "驴Cu谩l es el nombre de este compuesto?", val2: "H2O", correct: "Agua", distractors: ["Oxidano", "Di贸xido de hidr贸geno", "cido h铆drico"], error_explanation: "" },
            { val1: "驴Cu谩l es el nombre de este compuesto?", val2: "CO2", correct: "Di贸xido de carbono", distractors: ["Mon贸xido de carbono", "xido de carbono", "Carbonato"], error_explanation: "" }
        ];

        let score = 0;
        let streak = 0;
        let lives = 0;
        let currentQuestion = null;
        let questionsPool = []; // Preguntas que quedan por acertar
        let totalQuestions = 0;

        function formatear(str) {
            if (!str) return "";
            return str
                .replace(/^###\s*(.*$)/gm, '<h3>$1</h3>')
                .replace(/^\*\s*(.*$)/gm, '<li>$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/_(\d+)/g, '<sub>$1</sub>')
                .replace(/\^(\d+)/g, '<sup>$1</sup>');
        }

        function startGame() {
            score = 0;
            streak = 0;
            const data = (window.json_data && window.json_data.database) ? window.json_data.database : database_fallback;

            // Clonamos la base de datos para el pool de preguntas
            questionsPool = [...data];
            totalQuestions = questionsPool.length;
            lives = (window.json_data && window.json_data.vidas) ? window.json_data.vidas : 3;

            if (window.json_data) {
                document.getElementById('help-title').innerHTML = formatear(window.json_data.help_title) || "Tema";
                document.getElementById('help-desc').innerHTML = formatear(window.json_data.help_content) || "Instrucci贸n";
            }

            updateStats();
            loadRandomQuestion();
        }

        function updateStats() {
            document.getElementById('score').innerText = `Puntos: ${score}`;
            let hearts = "";
            for (let i = 0; i < lives; i++) hearts += "わ";
            document.getElementById('lives').innerText = hearts;

            // Progreso
            const acertadas = totalQuestions - questionsPool.length;
            document.getElementById('progress-text').innerText = `${acertadas}/${totalQuestions}`;
            const percent = (acertadas / totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = percent + "%";
        }

        function loadRandomQuestion() {
            if (lives <= 0) return; // Ya gestionado por el modal

            if (questionsPool.length === 0) {
                return showVictory();
            }

            const randomIndex = Math.floor(Math.random() * questionsPool.length);
            currentQuestion = questionsPool[randomIndex];

            let options = [...currentQuestion.distractors, currentQuestion.correct];
            options.sort(() => Math.random() - 0.5);

            const display = document.getElementById('display');
            const instruction = document.getElementById('instruction');
            const container = document.getElementById('options-container');

            container.innerHTML = '';
            instruction.innerText = currentQuestion.val1;
            display.innerHTML = formatear(currentQuestion.val2);

            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = `option-btn color-${index % 4}`;
                btn.innerHTML = formatear(opt);
                btn.onclick = () => checkAnswer(opt, btn);
                container.appendChild(btn);
            });

            document.getElementById('modal').style.display = 'none';
        }

        function checkAnswer(selected, btnElement) {
            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.disabled = true);

            const isCorrect = (selected === currentQuestion.correct);

            if (isCorrect) {
                btnElement.classList.add('correct');
                score += 10 + (streak * 2);
                streak++;

                // IMPORTANTE: Si acierta, eliminamos la pregunta del pool
                questionsPool = questionsPool.filter(q => q !== currentQuestion);

                setTimeout(() => showModal(true), 600);
            } else {
                btnElement.classList.add('wrong');
                lives--;
                streak = 0;
                // Si falla, la pregunta SE QUEDA en el pool para repetirse luego
                allBtns.forEach(b => {
                    if (b.innerHTML === formatear(currentQuestion.correct)) b.classList.add('correct');
                });
                setTimeout(() => showModal(false), 600);
            }
            updateStats();
        }

        function showModal(isWin) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const msg = document.getElementById('modal-msg');
            const actionBtn = document.getElementById('action-btn');
            const shareBtn = document.getElementById('share-btn');

            modal.style.display = 'flex';
            shareBtn.style.display = 'none';

            if (!isWin && lives <= 0) {
                title.innerText = "隆Game Over!";
                title.style.color = "var(--error)";
                msg.innerHTML = `Te has quedado sin vidas.<br>Puntuaci贸n: ${score}`;
                actionBtn.innerText = "Reintentar todo";
                actionBtn.onclick = startGame;
                return;
            }

            if (isWin) {
                title.innerText = "隆Correcto!";
                title.style.color = "var(--success)";
                msg.innerText = "隆Dominas esta f贸rmula!";
                actionBtn.innerText = "Siguiente";
                actionBtn.onclick = nextQuestion;
            } else {
                title.innerText = "隆Casi!";
                title.style.color = "var(--error)";
                let expl = currentQuestion.error_explanation ? `<br><small>${currentQuestion.error_explanation}</small>` : "";
                msg.innerHTML = `La respuesta correcta era:<br><br><strong>${currentQuestion.correct}</strong><br>${expl}`;
                actionBtn.innerText = "Continuar";
                actionBtn.onclick = nextQuestion;
            }
        }

        function showVictory() {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const msg = document.getElementById('modal-msg');
            const actionBtn = document.getElementById('action-btn');
            const shareBtn = document.getElementById('share-btn');

            modal.style.display = 'flex';
            title.innerText = "隆ENHORABUENA! ";
            title.style.color = "var(--victory)";
            msg.innerHTML = `隆Has completado todas las preguntas!<br>Puntuaci贸n final: <strong>${score}</strong><br>Vidas restantes: ${lives}`;

            actionBtn.innerText = "Jugar de nuevo";
            actionBtn.onclick = startGame;
            shareBtn.style.display = 'block';
        }

        function nextQuestion() {
            loadRandomQuestion();
        }

        function shareScore() {
            const text = `隆He completado el test de Qu铆mica con ${score} puntos! И`;
            if (navigator.share) {
                navigator.share({ title: 'Reto Qu铆mica', text: text });
            } else {
                navigator.clipboard.writeText(text);
                alert("Puntuaci贸n copiada al portapapeles");
            }
        }

        window.addEventListener("message", (event) => {
            // Verificamos que sea el mensaje correcto
            if (event.data && event.data.type === "INIT_DATA") {
                window.json_data = event.data.payload;

                startGame();
            }
        });
    </script>
</body>

</html>