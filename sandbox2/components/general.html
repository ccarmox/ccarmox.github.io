<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="main-title">Formulaci√≥n qu√≠mica</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --error: #c0392b;
        }

        /* Azul - Vibrante y confiable */
        .color-0 {
            border: 3px solid #71a4f7;
            background-color: #4285F4;
            color: #FFFFFF;
        }

        /* Rojo - Intenso y llamativo */
        .color-1 {
            border: 3px solid #f56f63;
            background-color: #EA4335;
            color: #FFFFFF;
        }

        /* Amarillo - Brillante y alegre */
        .color-2 {
            border: 3px solid #ffd965;
            background-color: #FBBC05;
            color: #343434;
            /* Texto oscuro para mejor contraste en amarillo */
        }

        /* Verde - Fresco y positivo */
        .color-3 {
            border: 3px solid #5dc779;
            background-color: #34A853;
            color: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            color: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0px;
        }

        .game-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            overflow: hidden;
            position: relative;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: #34495e;
            color: #bdc3c7;
            font-size: 0.9em;
        }

        .question-area {
            padding: 30px 20px;
            text-align: center;
        }

        .chemical-formula {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 20px;
            height: 60px;
        }

        .instruction {
            color: #7f8c8d;
            margin-bottom: 25px;
            font-style: italic;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 0 20px 30px;
        }

        @media (min-width: 500px) {
            .options-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        button.option-btn {
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
            transition: filter 0.2s ease;
            /* Para que el cambio sea suave */
        }

        button.option-btn:hover {
            filter: brightness(1.25);
            /* 1 es original, 0.85 es un 15% m√°s oscuro */
        }

        button.option-btn:active {
            filter: brightness(1.7);
            /* Se oscurece m√°s al hacer clic */
        }



        button.option-btn.correct {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
        }

        button.option-btn.wrong {
            background-color: var(--error);
            border-color: var(--error);
            color: white;
        }

        .feedback-modal {
            box-sizing: border-box;
            padding: 30px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            display: none;
            text-align: center;
        }

        /* Estilo contenedor botones modal */
        .modal-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 30px;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
        }

        .next-btn {
            background: var(--primary);
        }

        .share-btn {
            background: var(--accent);
            display: none;
            /* Oculto por defecto */
        }

        sub {
            font-size: 0.6em;
        }

        .context-area {
            background-color: #f8f9fa;
            padding: 35px 30px;
            border-bottom: 1px solid #e0e0e0;
            text-align: start;
        }

        .context-area h3 {
            margin: 0 0 5px 0;
            color: var(--accent);
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .context-area p {
            margin: 0;
            font-size: 0.9em;
            color: #7f8c8d;
            line-height: 1.4;
        }

        .play-area {
            position: relative;
            /* Esto atrapa al modal absoluto */
            display: flex;
            flex-direction: column;
            height: 100%;
            /* Para llenar el espacio restante si es necesario */
        }
    </style>
</head>

<body>

    <div class="game-container">
        <header>
            <h1 id="main-description">üß™ Qu√≠mica</h1>
        </header>

        <div class="stats-bar">
            <span id="score">Puntos: 0</span>
            <span id="streak">Racha: 0</span>
            <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
        </div>

        <div class="context-area">
            <h3 id="help-title">Tema: Formulaci√≥n</h3>
            <p id="help-desc">Selecciona la opci√≥n correcta.</p>
        </div>

        <div class="play-area">

            <div class="question-area">
                <div class="instruction" id="instruction">Selecciona la respuesta correcta:</div>
                <div class="chemical-formula" id="display">Cargando...</div>
            </div>

            <div class="options-grid" id="options-container">
            </div>

            <div class="feedback-modal" id="modal">
                <h2 id="modal-title">¬°Correcto!</h2>
                <p id="modal-msg">Muy bien hecho.</p>

                <div class="modal-buttons">
                    <button id="action-btn" class="modal-btn next-btn" onclick="nextQuestion()">Siguiente
                        Pregunta</button>
                    <button id="share-btn" class="modal-btn share-btn" onclick="shareScore()">üì§ Compartir</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- BASE DE DATOS DE PREGUNTAS ---
        const json_data = window.json_data;

        const ejemplo = [
            { val1: "¬øCu√°l es el nombre correcto de este compuesto?", val2: "Na2O", correct: "√ìxido de sodio", distractors: ["Di√≥xido de sodio", "√ìxido de disodio(I)", "√ìxido s√≥dico"], error_explanation: "" },
        ];

        // --- L√ìGICA DEL JUEGO ---
        let score = 0;
        let streak = 0;
        let lives = 0;
        let currentQuestion = null;

        function formatear(str) {
            return str
                // 1. Encabezados (### Texto -> <h3>Texto</h3>)
                .replace(/^###\s*(.*$)/gm, '<h3>$1</h3>')

                // 2. Listas punteadas (* Texto -> <li>Texto</li>)
                // Nota: Esto envuelve la l√≠nea en <li>, pero para un HTML v√°lido 
                // lo ideal ser√≠a envolver todo en un <ul> exterior despu√©s.
                .replace(/^\*\s*(.*$)/gm, '<li>$1</li>')

                // 3. Negritas (**Texto**)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')

                // 4. Sub√≠ndices y Super√≠ndices (tus funciones originales)
                .replace(/_(\d+)/g, '<sub>$1</sub>')
                .replace(/\^(\d+)/g, '<sup>$1</sup>');
        }

        function startGame() {
            score = 0;
            streak = 0;
            // Comprobaci√≥n de seguridad por si json_data no ha cargado a√∫n
            lives = (json_data && json_data.vidas) ? json_data.vidas : 3;

            if (json_data) {
                document.getElementById('help-title').innerHTML = formatear(json_data.help_title) || "Tema";
                document.getElementById('help-desc').innerHTML = formatear(json_data.help_content) || "Instrucci√≥n";
            }

            updateStats();
            loadRandomQuestion();
        }

        function updateStats() {
            document.getElementById('score').innerText = `Puntos: ${score}`;
            document.getElementById('streak').innerText = `Racha: ${streak}`;
            let hearts = "";
            for (let i = 0; i < lives; i++) hearts += "‚ù§Ô∏è";
            document.getElementById('lives').innerText = hearts;
        }

        function loadRandomQuestion() {
            if (lives <= 0) return gameOver();

            // Elegir pregunta al azar
            const database = (json_data && json_data.database) ? json_data.database : ejemplo;
            const randomIndex = Math.floor(Math.random() * database.length);
            const data = database[randomIndex];
            currentQuestion = data;

            // Mezclar opciones
            let options = [...data.distractors, data.correct];
            options.sort(() => Math.random() - 0.5);

            // Renderizar en el DOM
            const display = document.getElementById('display');
            const instruction = document.getElementById('instruction');
            const container = document.getElementById('options-container');

            container.innerHTML = '';

            instruction.innerText = data.val1;
            display.innerHTML = formatear(data.val2);

            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = `option-btn color-${index % 4}`;
                btn.innerHTML = formatear(opt);
                btn.onclick = () => checkAnswer(opt, btn);
                container.appendChild(btn);
            });

            document.getElementById('modal').style.display = 'none';
        }


        function obtenerMensajeMotivador() {
            const mensajes = [
                // --- √âpicas y Directas ---
                "¬°Exacto! Est√°s en racha. üî•",
                "¬°Brillante! Ni Einstein lo habr√≠a hecho mejor. üß†",
                "¬°Eso es! Tu cerebro est√° a otro nivel hoy. üöÄ",
                "¬°Pum! Respuesta perfecta. üéØ",
                "¬°Incre√≠ble! Lo haces ver muy f√°cil. ‚ú®",
                "¬°Diste en el clavo! Sigue as√≠. üôå",
                "¬°Imparable! Tienes el control total. üí™",

                // --- Con Humor / Ingeniosas ---
                "¬°Correcto! Tiembla, Google, aqu√≠ llega la competencia. üòâ",
                "¬øSeguro que no est√°s haciendo trampa? ¬°Eres demasiado bueno! üëÄ",
                "Tu teclado debe estar echando humo con tanto acierto. üí®",
                "¬°Boom! Esa respuesta ha sido legendaria. üé∏",
                "¬°Confirmado! Eres la persona m√°s inteligente en esta habitaci√≥n. (Probablemente). üèÜ",
                "¬°Hackeaste el sistema! Ah, no, espera... es que eres muy inteligente. üíª",

                // --- Motivadoras y C√°lidas ---
                "¬°Sab√≠a que lo lograr√≠as! Confianza al 100%. üåü",
                "Cada acierto te acerca m√°s a la maestr√≠a. üéì",
                "¬°Qu√© elegancia la de Francia! Respuesta perfecta. üé©",
                "¬°Wow! Me has dejado sin palabras. üëè",
                "¬°Sigue as√≠! Est√°s dominando el tema por completo. üîù",
                "¬°Toma ya! Una m√°s para la colecci√≥n de victorias. üèÖ",
                "¬°Nivel Dios activado! ‚ö°"
            ];

            const indiceAleatorio = Math.floor(Math.random() * mensajes.length);
            return mensajes[indiceAleatorio];
        }

        function obtenerMensajeAnimo() {
            const mensajesAnimo = [
                // --- Empat√≠a y Apoyo ---
                "Casi lo tienes, ¬°no te rindas ahora! üí™",
                "¬°No pasa nada! De los errores se aprende m√°s que de los aciertos. ‚ú®",
                "Estuviste muy cerca. ¬°Dale otra oportunidad! üîÑ",
                "Incluso los genios fallan a veces. ¬°Sigue adelante! üß†",
                "Tu cerebro est√° calentando motores, ¬°la pr√≥xima es la tuya! üî•",

                // --- Con un toque de Humor ---
                "¬°Ups! El teclado te ha traicionado, estoy seguro. üëÄ",
                "Eso fue un 'ensayo cl√≠nico'. Ahora viene la de verdad. üòâ",
                "404: Respuesta no encontrada... pero tu talento sigue ah√≠. üíª",
                "El sistema dice que no, pero yo conf√≠o en ti. ü§ñ",
                "Esa respuesta era demasiado avanzada para esta pregunta. ¬°Prueba otra! üöÄ",

                // --- Motivaci√≥n Directa ---
                "¬°A la carga de nuevo! T√∫ puedes con esto. üõ°Ô∏è",
                "Ni un paso atr√°s, ¬°vuelve a intentarlo! üëä",
                "¬°Casi rozas la gloria! Int√©ntalo una vez m√°s. üåü",
                "El √©xito es la suma de peque√±os intentos. ¬°Vas por buen camino! üìà"
            ];

            const indiceAleatorio = Math.floor(Math.random() * mensajesAnimo.length);
            return mensajesAnimo[indiceAleatorio];
        }

        function obtenerMensajeFinVidas() {
            const mensajesFin = [
                // --- Enfoque en el Progreso ---
                "¬°Se acabaron las vidas, pero no el talento! T√≥mate un respiro y vuelve a por el r√©cord. üéÆ",
                "Has llegado muy lejos en esta ronda. ¬°La pr√≥xima vez llegar√°s incluso m√°s all√°! üèÜ",
                "Tu puntuaci√≥n dice 'Fin', pero tu cerebro dice '¬°He aprendido algo nuevo!'. üß†",
                "¬°Game Over! Pero recuerda: cada partida te hace m√°s sabio que la anterior. üìñ",

                // --- Estilo Gaming / √âpico ---
                "Incluso los mejores necesitan un 'respawn'. ¬°Recarga energ√≠as y vuelve a la carga! ‚ö°",
                "Has ca√≠do con honor. ¬°Lev√°ntate, sac√∫dete el polvo y demuestra de qu√© est√°s hecho! üî•",
                "¬øUn descanso? Tu teclado te lo agradecer√°, pero yo te espero aqu√≠ para la revancha. ü•ä",
                "¬°Casi bates tu propia marca! Un intento m√°s y el podio es tuyo. üéØ",

                // --- Motivaci√≥n y Resiliencia ---
                "Las vidas son limitadas, pero tu potencial no. ¬°Vuelve a intentarlo cuando est√©s listo! ‚ú®",
                "No lo veas como un final, sino como un punto de control para volver con m√°s fuerza. üíæ",
                "¬°Buen intento! Roma no se construy√≥ en un d√≠a, y tu maestr√≠a tampoco. üèõÔ∏è",
                "¬°Insert Coin emocional! Tienes todo lo necesario para superar este nivel. üïπÔ∏è"
            ];

            const indiceAleatorio = Math.floor(Math.random() * mensajesFin.length);
            return mensajesFin[indiceAleatorio];
        }

        function checkAnswer(selected, btnElement) {
            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.disabled = true);

            const isCorrect = (selected === currentQuestion.correct);

            if (isCorrect) {
                btnElement.classList.add('correct');
                score += 10 + (streak * 2);
                streak++;
                showModal(true);
            } else {
                btnElement.classList.add('wrong');
                lives--;
                streak = 0;
                allBtns.forEach(b => {
                    // Peque√±o fix: usamos innerHTML para comparar con el formato de los botones
                    let textCheck = formatear(currentQuestion.correct);
                    if (b.innerHTML === textCheck) b.classList.add('correct');
                });

                // Si lives es 0, mostramos primero el error, pero el modal se encargar√° de gestionar el bot√≥n
                showModal(false);
            }
            updateStats();
        }

        function showModal(isWin) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const msg = document.getElementById('modal-msg');
            const actionBtn = document.getElementById('action-btn');
            const shareBtn = document.getElementById('share-btn');

            modal.style.display = 'flex';
            shareBtn.style.display = 'none';

            // CASO 1: El usuario acaba de perder su √∫ltima vida (Mostramos el error primero)
            // Pero usamos una condici√≥n especial: si lives es 0 y acabamos de fallar.
            if (!isWin && lives <= 0) {
                title.innerText = "¬°Incorrecto!";
                title.style.color = "var(--error)";
                let correctText = currentQuestion.correct + (currentQuestion.error_explanation ? " " + currentQuestion.error_explanation : "");
                msg.innerHTML = formatear(`La respuesta correcta era: <strong>${correctText}</strong><br><br>¬°Era tu √∫ltima vida! üíî`);

                actionBtn.innerText = "Ver Puntuaci√≥n Final";
                actionBtn.onclick = () => showFinalScore(); // Nueva funci√≥n
                return;
            }

            // CASO 2: Gan√≥ la pregunta
            if (isWin) {
                title.innerText = "¬°Correcto!";
                title.style.color = "var(--success)";
                msg.innerText = obtenerMensajeMotivador();
                actionBtn.innerText = "Siguiente Pregunta";
                actionBtn.onclick = nextQuestion;
            }
            // CASO 3: Fall√≥ pero a√∫n tiene vidas
            else {
                title.innerText = "Incorrecto";
                title.style.color = "var(--error)";
                let correctText = currentQuestion.correct + (currentQuestion.error_explanation ? " " + currentQuestion.error_explanation : "");
                msg.innerHTML = formatear(`La respuesta correcta era: <strong>${correctText}</strong><br><br>${obtenerMensajeAnimo()}`);
                actionBtn.innerText = "Siguiente Pregunta";
                actionBtn.onclick = nextQuestion;
            }
        }

        // Nueva funci√≥n para mostrar la pantalla de Game Over real
        function showFinalScore() {
            const title = document.getElementById('modal-title');
            const msg = document.getElementById('modal-msg');
            const actionBtn = document.getElementById('action-btn');
            const shareBtn = document.getElementById('share-btn');

            title.innerText = "Juego Terminado";
            title.style.color = "var(--primary)";
            msg.innerText = `Puntuaci√≥n final: ${score} \n\n${obtenerMensajeFinVidas()}`;

            actionBtn.innerText = "Reintentar";
            actionBtn.onclick = startGame;
            shareBtn.style.display = 'block';
        }

        function formatScoreWithEmoji(score) {
            let emoji = "";

            if (score >= 500) {
                emoji = "üëë"; // Nivel Dios
            } else if (score >= 300) {
                emoji = "üöÄ"; // Experto
            } else if (score >= 200) {
                emoji = "üî•üî•üî•"; // Qu√≠mico avanzado
            } else if (score >= 100) {
                emoji = "üî•üî•"; // Qu√≠mico avanzado
            } else if (score >= 80) {
                emoji = "üî•"; // Buena racha
            } else if (score >= 30) {
                emoji = "üòé"; // Decente
            } else if (score > 0) {
                emoji = "üê£"; // Principiante
            } else {
                emoji = "üíÄ"; // 0 puntos
            }

            return `${score} ${emoji}`;
        }

        function shareScore() {

            const score2 = formatScoreWithEmoji(score)

            const shareData = {
                title: json_data.titulo,
                text: `¬°He conseguido ${score2} puntos en el juego de ${json_data.help_title}! üß™ ¬øPuedes superarme?`
            };

            // Intentar usar la API nativa de compartir (M√≥vil/Tablets)
            if (navigator.share) {
                navigator.share(shareData)
                    .catch((error) => console.log('Error compartiendo', error));
            } else {
                // Fallback: Copiar al portapapeles si no es compatible (PC)
                navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`)
                    .then(() => {
                        const btn = document.getElementById('share-btn');
                        const originalText = btn.innerText;
                        btn.innerText = "¬°Copiado!";
                        setTimeout(() => btn.innerText = originalText, 2000);
                    })
                    .catch(err => {
                        alert("No se pudo compartir autom√°ticamente. Tu puntuaci√≥n es: " + score);
                    });
            }
        }

        function nextQuestion() {
            loadRandomQuestion();
        }

        function gameOver() {
            showModal(false);
        }

        // Iniciar
        startGame();

    </script>
</body>

</html>